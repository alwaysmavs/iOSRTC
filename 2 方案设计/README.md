## 七牛连麦方案设计

### 1. 概述

七牛的连麦方案与七牛直播云紧密结合，在不改变原有的推流&拉流工作流程的基础上，提供了简单易用的连麦对讲功能。该方案主要包括连麦服务端和客户端两个部分，其中，连麦服务端主要提供了房间管理、权限验证、信令和媒体数据转发等功能，客户端则提供了媒体数据的采集、编码、传输、显示等功能。

### 2. 连麦方案的整体设计

#### 2.1 连麦方案的系统框图

![连麦SDK方案框图](http://o94p2vvz7.bkt.clouddn.com/%E4%B8%83%E7%89%9B%E8%BF%9E%E9%BA%A6%E6%96%B9%E6%A1%88%E6%A1%86%E5%9B%BE-v0.5.0.1.png)

如图所示，左边是连麦的系统，右边是原有的推流&拉流系统，连麦系统使用了 WebRTC 框架，数据传输采用了 UDP 协议，以达到降低延时的目的。

在没有连麦的时候，主播 A 将自己的流推送到 Pili 的流媒体服务器，观众则通过 CDN 播放主播的流。

一旦连麦开始，主播 A 会将自己的音视频流再推送一路到 WebRTC 媒体服务器，同时拉取  WebRTC 媒体服务器上其他两路连麦对象的流，进行本地合成，然后再推送到 Pili 的流媒体服务器上。

#### 2.2 连麦方案的权限控制

“连麦” 其实就是一个 “视频会议” ，因此我们引入了 “连麦房间” 的概念，用于隔离不同主播的连麦过程，保障数据的安全以及互不干扰。本方案要求连麦的各方必须首先进入同一个  “连麦房间” ，然后才能开始 “视频会议” 的过程。

![连麦的房间管理](http://o94p2vvz7.bkt.clouddn.com/%E8%BF%9E%E9%BA%A6%E6%88%BF%E9%97%B4%E7%AE%A1%E7%90%86-v0.6.0.png)

房间的 API 主要分为两个部分，一部分在服务端，另一部分在客户端，我们把创建/销毁 “连麦房间” 的功能放到了服务端，由 App Server 向七牛的服务器发送申请来完成。连麦客户端 SDK，只有加入/离开 “连麦房间” 的权限。 

房间其实不需要每次直播都创建再销毁，而是可以预先为每一个有连麦权限的主播分配好，需要收回连麦权限的时候，再销毁掉。

#### 2.3 连麦的交互示意图

![连麦的交互图](http://o94p2vvz7.bkt.clouddn.com/%E4%B8%83%E7%89%9B%E8%BF%9E%E9%BA%A6%E4%BA%A4%E4%BA%92%E5%9B%BE-v0.3.0.png)

**因此，服务端需要开发的工作如下**：

- 为主播创建 “连麦房间号”，并将 “连麦房间号”和该主播的ID对应关系存储起来
- 计算连麦的 Token 并提供给客户端，该 Token 是根据七牛的 AK、SK 按照一定的规则生成
- 提供连麦的业务逻辑，如：观众申请连麦，主播同意/拒绝连麦等消息处理

#### 2.4 连麦的流程

实际上，连麦在业务上存在三种角色，“主播”，“副主播”，“普通观众”，不同的角色，业务流程是不一样的。

- 主播（推流＋连麦+合流）

    主播是负责推流和合流的角色，数据来自自身的采集和连麦的副主播，其工作流程如下：
    
    打开本地摄像头预览 -> 初始化推流参数 -> 开始推流［主播画面］-> -> -> 收到连麦申请(业务服务器) -> 同意连麦申请(业务服务器) -> 开始连麦-> 持续推流[合成画面] -> -> -> 结束连麦-> 持续推流［主播画面］-> -> -> 结束推流

- 副主播/连麦观众（连麦）

    副主播是连麦后跟主播视频对讲的角色，其工作流程如下：
    
    打开本地摄像头预览 -> 向主播申请连麦(业务服务器) -> "得到同意"(业务服务器) -> 开始连麦-> -> -> 结束连麦

- 普通观众（播放）

    观众是观看者角色，从流媒体分发网络拉取主播推送的音视频码流，其工作流程如下：
    
    播放主播画面 -> -> ->  退出播放器

